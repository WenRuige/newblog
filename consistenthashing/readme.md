#### 一致性哈希


> 为什么要用一致性哈希?

假设我们有一组缓存服务器,为了将图片相对均匀的存储在三台缓存服务器上,我们可能会对服务器进行取模
hash(图片地址) % 服务器数量,这样就会有一个弊端,当某一台服务器挂掉了,无法进行缓存,那么对于挂掉的机器之前的请求流量,可能会打到其他两台机器上,由于大量缓存同一时间失效,可能会导致缓存雪崩问题出现

> 一致性hash的性质

* 平衡性(`balance`):哈希能够尽可能的分布到所有缓冲中去,这样可以让所有的缓冲空间都得到利用
* 单调性(`Monotonicity`):
* 分散性(`Spread`):
* 负载(`Load`):
* 平滑性(`Smoothness`):平滑改变

##### 一致性哈希实现方式

一致性哈希也是使用取模的方式,普通的哈希方式可能是对服务器数量进行取模
但是一致性哈希是在0 - 2^32-1 之间的值




假设我们有三台服务器,那么对应的地址为:

* hash(服务器A地址) % 2^32
* hash(服务器B地址) % 2^32
* hash(服务器C地址) % 2^32


假设我们需要缓存的数据为图片,那么我们可以用如下方式将哈希映射到环上
```
hash(图片名称) % 2^32
hash(图片名称1) % 2^32
....(依次类推)
```


那么这张图片应该映射到哪一台服务器上呢?

上图图片会缓存到服务器A上,会默认寻找地址最接近hash后服务器的地址的数据




##### 哈希环的偏斜





##### 虚拟节点

因为有可能节点分布非非常不均匀,导致某些数据都命中到同一个Node上,这里就需要引入虚拟节点的存在

既对每一个服务节点计算多个哈希,每个计算结果位置都放置一个服务节点,称为虚拟节点
比如 `node#1`,`node#2`,`node#3`以此类推



##### 一致性哈希和其他算法的对比

hash取模: 均衡性上没问题,但是集群中新增一个节点的话,将有N/(N+1)的数据失效

slot映射:现将key做一定运算(crc16,crc32,hash)获得一个整数值,在将该值与固定的槽数取模,

一致性hash:更新一个节点的失败率为1/(N+1) eg n=1   1/(1 + 1) = 1/2



参考资料:
[一致性哈希参考](http://www.zsythink.net/archives/1182/)